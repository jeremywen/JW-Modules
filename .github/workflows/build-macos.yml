name: Build VCV Rack Plugin for macOS

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

env:
  rack-sdk-version: 2.6.4

jobs:
  build-macos:
    name: macOS (${{ matrix.arch }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Install build dependencies
      run: |
        brew update
        brew install wget git autoconf automake libtool pkg-config

    - name: Download and setup VCV Rack SDK
      run: |
        cd $HOME
        wget https://vcvrack.com/downloads/Rack-SDK-${{ env.rack-sdk-version }}-mac-${{ matrix.arch }}.zip
        unzip Rack-SDK-${{ env.rack-sdk-version }}-mac-${{ matrix.arch }}.zip

        # Set environment variable for subsequent steps
        echo "RACK_DIR=$HOME/Rack-SDK" >> $GITHUB_ENV

    - name: Build plugin
      run: |
        # Only set CROSS_COMPILE for x64 builds (cross-compiling from arm64)
        # macos-latest runners are arm64, so arm64 builds are native
        echo "Building for architecture: ${{ matrix.arch }}"

        if [ "${{ matrix.arch }}" = "x64" ]; then
          echo "Setting CROSS_COMPILE for x64 cross-compilation"
          export CROSS_COMPILE=x86_64-apple-darwin
        else
          echo "Native arm64 build - CROSS_COMPILE not set"
          unset CROSS_COMPILE
        fi

        echo "CROSS_COMPILE is: ${CROSS_COMPILE:-<not set>}"

        # Build the plugin
        make -j$(sysctl -n hw.ncpu) RACK_DIR=$HOME/Rack-SDK

        # Verify the plugin was built and check its architecture
        ls -lh plugin.dylib
        echo "Plugin architecture:"
        lipo -archs plugin.dylib

    - name: Create distribution package
      run: |
        # Only set CROSS_COMPILE for x64 builds
        if [ "${{ matrix.arch }}" = "x64" ]; then
          export CROSS_COMPILE=x86_64-apple-darwin
        else
          unset CROSS_COMPILE
        fi

        # Create the distribution package
        make dist RACK_DIR=$HOME/Rack-SDK

        # List the created distribution files
        echo "Distribution files:"
        ls -lh dist/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: jwmodules-macos-${{ matrix.arch }}-${{ github.run_number }}-${{ github.sha }}
        path: |
          dist/*.vcvplugin
        retention-days: 30

    - name: Upload release assets (if tagged)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/*.vcvplugin
        token: ${{ secrets.GITHUB_TOKEN }}
